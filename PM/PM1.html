<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>PM Inbox</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body { font-family: system-ui, -apple-system, Roboto, "Segoe UI", Arial; margin:0; padding:16px; background:#f8fafc; }
    .card { background:#fff; padding:16px; border-radius:10px; box-shadow:0 6px 18px rgba(0,0,0,.06); max-width:760px; margin:16px auto; }
    h1 { margin:0 0 12px 0 }
    .msg { border:1px solid #eee; padding:10px; border-radius:8px; margin-top:10px; }
    .meta { font-size:12px; color:#666 }
    button { margin-top:8px; padding:8px 10px; border-radius:8px; border:0; background:#ef4444; color:#fff; cursor:pointer }
    .controls { display:flex; gap:8px; margin-top:8px; }
  </style>
</head>
<body>
  <div class="card">
    <h1>Your Inbox</h1>
    <div id="status" class="meta">Loading...</div>
    <div id="msgs"></div>
    <div style="margin-top:12px;">
      <button id="clearBtn">Delete All Messages</button>
    </div>
  </div>

<script>
const WORKER_URL = 'https://pm-worker.clip-devious-turf.workers.dev' // << replace

function el(tag, props={}, ...children) {
  const e = document.createElement(tag)
  for (const k in props) {
    if (k.startsWith('on')) e.addEventListener(k.slice(2), props[k])
    else e[k]=props[k]
  }
  for (const c of children) if (c!==null) e.appendChild(typeof c==='string' ? document.createTextNode(c):c)
  return e
}
function queryId() {
  const p = new URL(location.href).searchParams
  return p.get('id')
}
async function fetchInbox(id) {
  const res = await fetch(WORKER_URL + '/inbox?id=' + encodeURIComponent(id))
  return res.json()
}
async function deleteMessage(id, messageID) {
  const res = await fetch(WORKER_URL + '/deleteMessage', {
    method:'POST', headers:{ 'Content-Type':'application/json' },
    body: JSON.stringify({ id, messageID })
  })
  return res.json()
}
async function deleteAll(id) {
  const res = await fetch(WORKER_URL + '/deleteAll', {
    method:'POST', headers:{ 'Content-Type':'application/json' },
    body: JSON.stringify({ id })
  })
  return res.json()
}

(async ()=>{
  const id = queryId()
  if (!id) {
    document.getElementById('status').textContent = 'Missing id parameter'
    return
  }
  document.getElementById('status').textContent = 'Loading...'
  try {
    const data = await fetchInbox(id)
    if (!data.ok) {
      document.getElementById('status').textContent = data.error || 'Failed'
      return
    }
    document.getElementById('status').textContent = 'Found ' + data.messages.length + ' message(s)'
    const container = document.getElementById('msgs')
    container.innerHTML = ''
    data.messages.slice().reverse().forEach(m=>{
      const box = el('div',{className:'msg'},
        el('div',{className:'meta'}, 'From: ' + m.senderUsername + ' â€” ' + new Date(m.ts).toLocaleString()),
        el('h4',{}, m.subject || '(no subject)'),
        el('div',{}, m.body),
        el('div',{className:'controls'},
          el('button',{onclick: async ()=>{
            if (!confirm('Delete this message?')) return
            const r = await deleteMessage(id, m.id)
            if (r.ok) {
              box.remove()
              document.getElementById('status').textContent = 'Deleted'
            } else {
              alert(r.error || 'Failed')
            }
          }}, 'Delete')
        )
      )
      container.appendChild(box)
    })
  } catch (err) {
    document.getElementById('status').textContent = err.message
  }

  document.getElementById('clearBtn').addEventListener('click', async ()=>{
    if (!confirm('Delete all messages?')) return
    const r = await deleteAll(id)
    if (r.ok) {
      document.getElementById('msgs').innerHTML = ''
      document.getElementById('status').textContent = 'Inbox cleared'
    } else {
      alert(r.error || 'Failed')
    }
  })
})()
</script>
</body>
</html>
