<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Private Messages</title>
<style>
body{background:#0a1a2f;color:#fff;font-family:Arial,sans-serif;margin:0;padding:0;}
.container{max-width:800px;margin:30px auto;background:#122b47;border-radius:12px;box-shadow:0 0 15px rgba(0,0,0,0.4);padding:20px;}
input,textarea,button{width:100%;padding:10px;margin:6px 0;border-radius:8px;border:none;font-size:15px;}
button{background:#1e90ff;color:#fff;cursor:pointer;}button:hover{background:#3aa0ff;}
.msg{background:#17395f;padding:10px;border-radius:8px;margin-bottom:10px;}
small{color:#aaa;}
</style>
</head>
<body>
<div class="container">
  <h2>Private Message Page</h2>
  <p id="info"></p>
  <h3>Send a Reply</h3>
  <input type="text" id="toUser" placeholder="Recipient Username">
  <input type="text" id="subject" placeholder="Subject">
  <textarea id="messageBox" placeholder="Write your message..."></textarea>
  <button id="sendBtn">Send Message</button>

  <h3>Your Inbox</h3>
  <div id="inbox"></div>
  <button id="refreshBtn">Refresh</button>
  <button id="deleteAllBtn">Delete All</button>
</div>

<script>
const WORKER_URL="https://pm-worker.clip-devious-turf.workers.dev";
const pmId=new URLSearchParams(window.location.search).get("id");
const username=localStorage.getItem("username");
const id=localStorage.getItem("id");

const info=document.getElementById("info");
const inbox=document.getElementById("inbox");
const refreshBtn=document.getElementById("refreshBtn");
const deleteAllBtn=document.getElementById("deleteAllBtn");
const sendBtn=document.getElementById("sendBtn");

if(!pmId){ info.textContent="Error: Missing PM ID."; } 
else { info.textContent="Your PM Page ID: "+pmId; }

// --- Load messages ---
async function loadMessages(){
  inbox.innerHTML="<p>Loading...</p>";
  const res=await fetch(`${WORKER_URL}/getMessages?pmId=${encodeURIComponent(pmId)}`);
  const data=await res.json();
  inbox.innerHTML="";
  if(!data.ok||!data.messages||!data.messages.length){ inbox.innerHTML="<p>No messages.</p>"; return; }
  data.messages.forEach(m=>{
    const div=document.createElement("div");
    div.className="msg";
    div.innerHTML=`<b>From:</b> ${m.from}<br><b>Subject:</b> ${m.subject||"(no subject)"}<br><p>${m.message}</p><small>${new Date(m.timestamp).toLocaleString()}</small><br><button onclick="deleteMsg('${m.id}')">Delete</button>`;
    inbox.appendChild(div);
  });
}

// --- Send Message ---
async function sendMessage(){
  const to=document.getElementById("toUser").value.trim();
  const subject=document.getElementById("subject").value.trim();
  const message=document.getElementById("messageBox").value.trim();
  if(!to||!message) return alert("Missing fields");
  const res=await fetch(`${WORKER_URL}/sendMessage`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({from:username,to,subject,message})});
  const data=await res.json();
  if(!data.ok) alert(data.error||"Failed"); else { alert("Sent!"); loadMessages(); }
}

// --- Delete Single ---
async function deleteMsg(msgId){
  if(!confirm("Delete message?")) return;
  const res=await fetch(`${WORKER_URL}/deleteMessage`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({pmId,msgId})});
  loadMessages();
}

// --- Delete All ---
async function deleteAll(){
  if(!confirm("Delete ALL messages?")) return;
  await fetch(`${WORKER_URL}/deleteAll`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({pmId})});
  loadMessages();
}

refreshBtn.onclick=loadMessages;
deleteAllBtn.onclick=deleteAll;
sendBtn.onclick=sendMessage;
loadMessages();
</script>
</body>
</html>
