<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Private Messages</title>
<style>
body{background:#0a1a2f;color:#fff;font-family:Arial,sans-serif;margin:0;padding:0;}
.container{max-width:800px;margin:30px auto;background:#122b47;border-radius:12px;box-shadow:0 0 15px rgba(0,0,0,0.4);padding:20px;}
input,textarea,button{width:100%;padding:10px;margin:6px 0;border-radius:8px;border:none;font-size:15px;}
button{background:#1e90ff;color:#fff;cursor:pointer;}button:hover{background:#3aa0ff;}
.msg{background:#17395f;padding:10px;border-radius:8px;margin-bottom:10px;}
small{color:#aaa;}

/* PM confirmation banner */
.pm-banner {
  margin-top: 12px;
  padding: 10px 14px;
  border-radius: 8px;
  color: #fff;
  font-weight: 600;
  text-align: center;
  box-shadow: 0 4px 12px rgba(0,0,0,0.3);
  transition: opacity .3s ease, transform .3s ease;
  opacity: 1;
}
.pm-banner-success { background: #28a745; }
.pm-banner-error { background: #dc3545; }
.pm-banner-hide { opacity: 0; transform: translateY(-6px); }

.tabs {
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
  margin-bottom: 10px;
  justify-content: center;
}
.tab {
  background: #2d72d9;
  border: none;
  color: white;
  padding: 6px 12px;
  border-radius: 6px;
  cursor: pointer;
  font-family: sans-serif;
  font-size: 14px;
  transition: background 0.2s ease;
}
.tab:hover { background: #1b4fa8; }
.tab.active { background: #15803d; }
.badge { font-size: 12px; margin-left: 3px; vertical-align: middle; }
</style>
</head>
<body>
<div class="container">
  <h2>Private Message Page</h2>
  <p id="info"></p>
  <h3>Send a Reply</h3>
  <input type="text" id="toUser" placeholder="Recipient Username">
  <input type="text" id="subject" placeholder="Subject">
  <textarea id="messageBox" placeholder="Write your message..."></textarea>
  <button id="sendBtn">Send Message</button>

  <h3>Your Inbox (auto-refreshes)</h3>
  <div id="conversationTabs" class="tabs"></div>
  <div id="inbox"></div>
  <button id="refreshBtn">Refresh</button>
  <button id="deleteAllBtn">Delete All</button>
</div>

<script>

const WORKER_URL="https://pm-worker.clip-devious-turf.workers.dev";
const pmId=new URLSearchParams(window.location.search).get("id");
const username=localStorage.getItem("username");
const id=localStorage.getItem("id");

const info=document.getElementById("info");
const inbox=document.getElementById("inbox");
const refreshBtn=document.getElementById("refreshBtn");
const deleteAllBtn=document.getElementById("deleteAllBtn");
const sendBtn=document.getElementById("sendBtn");

if(!pmId){ info.textContent="Error: Missing PM ID."; } 
else { info.textContent="Your PM Page ID: "+pmId; }

/* ===== PM PAGE SECURITY + UX ENHANCEMENTS ===== */

// Global flags
let inboxRevoked = false;

// üîê Login guard: block entire page if user not signed in
function ensureLoggedIn() {
  const username = localStorage.getItem("username");
  const userId = localStorage.getItem("id");

  if (!username || !userId) {
    document.body.innerHTML = `
      <div style="text-align:center;margin-top:60px;font-family:sans-serif;">
        <h2>üîí Please log in to access private messages.</h2>
        <p>Your session has ended or you are not signed in.</p>
        <button onclick="window.location.href='/index.html'">Go to Login</button>
      </div>`;
    return false;
  }
  return true;
}

// Run check on page load
if (!ensureLoggedIn()) {
  throw new Error("User not logged in ‚Äî messaging disabled");
}

//TABS for USERS 
let currentConversation = null;
let seenMessages = {};

function renderConversationTabs(messages) {
  const tabsContainer = document.getElementById("conversationTabs");
  if (!tabsContainer) return;

  const senders = [...new Set(messages.map(m => m.senderUsername))];
  tabsContainer.innerHTML = "";

  const allTab = document.createElement("button");
  allTab.textContent = "All";
  allTab.className = "tab active";
  allTab.onclick = () => {
    currentConversation = null;
    document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
    allTab.classList.add("active");
    document.getElementById("toUser").value = "";
    showMessages(messages);
  };
  tabsContainer.appendChild(allTab);

  senders.forEach(sender => {
    const btn = document.createElement("button");
    btn.className = "tab";
    const userMessages = messages.filter(m => m.senderUsername === sender);
    const lastSeen = seenMessages[sender] || 0;
    const latestMsg = Math.max(...userMessages.map(m => m.ts));
    const hasUnread = latestMsg > lastSeen;
    btn.innerHTML = `${sender}${hasUnread ? ' <span class="badge">üîµ</span>' : ''}`;
    btn.onclick = () => {
      currentConversation = sender;
      document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
      btn.classList.add("active");
      document.getElementById("toUser").value = sender;
      showMessages(userMessages);
      seenMessages[sender] = Date.now();
      btn.innerHTML = sender;
    };
    tabsContainer.appendChild(btn);
  });
}

function showMessages(msgList) {
  const inbox = document.getElementById("inbox");
  inbox.innerHTML = "";
  if (!msgList.length) {
    inbox.innerHTML = "<p>No messages.</p>";
    return;
  }
  msgList.slice().reverse().forEach((m) => {
    const div = document.createElement("div");
    div.className = "msg";
    div.innerHTML = `
      <b>From:</b> ${m.senderUsername}<br>
      <b>Subject:</b> ${m.subject || "(no subject)"}<br>
      <p>${m.body}</p>
      <small>${new Date(m.ts).toLocaleString()}</small><br>
      <button onclick="deleteMsg('${m.id}')">Delete</button>`;
    inbox.appendChild(div);
  });
}

// ===== Load messages from Worker =====
async function loadMessages() {
  try {
    const res = await fetch(`${WORKER_URL}/inbox?id=${encodeURIComponent(pmId)}`);
    const data = await res.json();

    // If revoked inbox
    if (res.status === 403 && data.error && data.error.toLowerCase().includes("revoked")) {
      inboxRevoked = true;
      document.body.innerHTML = `
        <div style="text-align:center;margin-top:60px;font-family:sans-serif;">
          <h2>‚ö†Ô∏è This PM link has expired or been revoked.</h2>
          <p>Please log in to your account to get your new active message link.</p>
          <button onclick="window.location.href='/index.html'">Go to Dashboard</button>
        </div>`;
      return;
    }

    // ‚úÖ If no messages
    if (!data.ok || !data.messages || !data.messages.length) {
      document.getElementById("inbox").innerHTML = "<p>No messages.</p>";
      return;
    }

    // ‚úÖ New tab rendering logic
    renderConversationTabs(data.messages);
    showMessages(
      currentConversation
        ? data.messages.filter(m => m.senderUsername === currentConversation)
        : data.messages
    );

  } catch (err) {
    console.error("Error loading inbox:", err);
  }
}

// --- Auto refresh every 10 seconds ---
let autoRefreshInterval=null;
function startAutoRefresh(){
  if(autoRefreshInterval) clearInterval(autoRefreshInterval);
  autoRefreshInterval=setInterval(loadMessages,10000);
}

// ===== Secure Send Message Function =====
async function sendMessage() {
  // üõë Block sending if page revoked
  if (inboxRevoked) {
    showBanner("This PM link is inactive ‚Äî please log in to get a new one.", "error");
    return;
  }

  // üîê Require login before sending
  const username = localStorage.getItem("username");
  const userId = localStorage.getItem("id");
  if (!username || !userId) {
    showBanner("You must be logged in to send messages.", "error");
    return;
  }

  const toUsername = document.getElementById("toUser").value.trim();
  const subjectEl = document.getElementById("subject");
  const msgEl = document.getElementById("messageBox") || document.getElementById("message");
  const subject = subjectEl ? subjectEl.value.trim() : "";
  const msgBody = msgEl ? msgEl.value.trim() : "";

  if (!toUsername || !msgBody) {
    showBanner("Please enter a username and message.", "error");
    return;
  }

  try {
    const res = await fetch(`${WORKER_URL}/sendPM`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        fromID: userId,
        toUsername,
        subject,
        body: msgBody
      })
    });

    const data = await res.json();

    // üß± Handle revoked recipient
    if (res.status === 403 && data.error && data.error.toLowerCase().includes("revoked")) {
      showBanner("Recipient's PM link has been revoked ‚Äî message not sent.", "error");
      return;
    }

    if (!data.ok) {
      showBanner("Failed to send: " + (data.error || "Unknown error"), "error");
      return;
    }

    // ‚úÖ Success
    if (subjectEl) subjectEl.value = "";
    if (msgEl) msgEl.value = "";
    showBanner("Message sent!", "success");

  } catch (err) {
    showBanner("Network error: " + err.message, "error");
  }
}

/* Banner helper used by sendMessage (non-invasive across page) */
function showBanner(text, kind = "success") {
  // remove existing banner
  const existing = document.querySelector(".pm-banner");
  if (existing) existing.remove();

  const banner = document.createElement("div");
  banner.className = "pm-banner " + (kind === "error" ? "pm-banner-error" : "pm-banner-success");
  banner.textContent = text;

  // append to container (or body fallback)
  const container = document.querySelector(".container") || document.body;
  container.appendChild(banner);

  // auto-hide after 3s
  setTimeout(() => {
    banner.classList.add("pm-banner-hide");
    setTimeout(() => banner.remove(), 300);
  }, 3000);
}


// --- Delete Single ---
async function deleteMsg(msgId){
  if(!confirm("Delete message?")) return;
  const res=await fetch(`${WORKER_URL}/deleteMessage`,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({pmId,msgId})
  });
  loadMessages();
}

// --- Delete All ---
async function deleteAll(){
  if(!confirm("Delete ALL messages?")) return;
  await fetch(`${WORKER_URL}/deleteAll`,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({pmId})
  });
  loadMessages();
}

refreshBtn.onclick=loadMessages;
deleteAllBtn.onclick=deleteAll;
sendBtn.onclick=sendMessage;

loadMessages();
startAutoRefresh();
</script>


<script>
// === Message Notification Add-on ===

// Lightweight sound file (base64-encoded ping)
const msgSound = new Audio("https://actions.google.com/sounds/v1/alarms/beep_short.ogg");

// Keep track of the last seen message count
let lastMessageCount = 0;

// Hook into your existing loadMessages()
const originalLoadMessages = loadMessages;
loadMessages = async function() {
  const res = await fetch(`${WORKER_URL}/inbox?id=${encodeURIComponent(pmId)}`);
  const data = await res.json();
  inbox.innerHTML = "";
  if(!data.ok || !data.messages || !data.messages.length){
    inbox.innerHTML="<p>No messages.</p>";
    lastMessageCount = 0;
    return;
  }
  data.messages.slice().reverse().forEach(m=>{
    const div=document.createElement("div");
    div.className="msg";
    div.innerHTML=`<b>From:</b> ${m.senderUsername}<br><b>Subject:</b> ${m.subject||"(no subject)"}<br><p>${m.body}</p><small>${new Date(m.ts).toLocaleString()}</small><br><button onclick="deleteMsg('${m.id}')">Delete</button>`;
    inbox.appendChild(div);
  });

  // --- Notification logic ---
  const count = data.messages.length;
  if (count > lastMessageCount) {
    // Only notify if tab not visible
    if (document.hidden) {
      msgSound.play().catch(()=>{});
      flashTitle();
    }
  }
  lastMessageCount = count;
};

// Title flashing
let flashing = false;
function flashTitle(){
  if(flashing) return;
  flashing = true;
  const origTitle = document.title;
  let toggle = false;
  const interval = setInterval(()=>{
    document.title = toggle ? "(1) New Message" : origTitle;
    toggle = !toggle;
    if(!document.hidden){
      clearInterval(interval);
      flashing = false;
      document.title = origTitle;
    }
  }, 1200);
}

// Reset on visibility change
document.addEventListener("visibilitychange", ()=>{
  if(!document.hidden){
    document.title = document.title.replace(/^\(1\) /,'');
  }
});
</script>


</body>
</html>
