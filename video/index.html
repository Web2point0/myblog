<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Protected Page</title>
  <link rel="stylesheet" href="style.css">
  <title>Meet Up - Click to Chat</title>
<style>
  body {
    font-family: system-ui, sans-serif;
    background: #111;
    color: #fff;
    display: flex;
    flex-direction: column;
    align-items: center;
    min-height: 100vh;
    margin: 0;
    padding: 20px;
  }
  h2 { margin-bottom: 10px; }
  #status { margin-bottom: 15px; font-weight: bold; }
  .video-container {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 10px;
    width: 100%;
    max-width: 900px;
  }
  .video-box {
    position: relative;
    flex: 1 1 300px;
    max-width: 420px;
    aspect-ratio: 16 / 9;
    background: #000;
    border-radius: 10px;
    overflow: hidden;
    display: flex;
    justify-content: center;
    align-items: center;
  }
  video {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }
  button {
    margin-top: 15px;
    padding: 12px 20px;
    font-weight: bold;
    border: none;
    border-radius: 6px;
    background: #0b84ff;
    color: #fff;
    cursor: pointer;
    font-size: 16px;
  }
  button:disabled { opacity: 0.5; cursor: not-allowed; }
  @media (max-width: 700px) {
    .video-container { flex-direction: column; }
    .video-box { width: 90%; aspect-ratio: 4/3; }
  }
</style>
</head>
<body>
  <div id="login-container">
    <h2>Enter Password</h2>
    
    <div class="password-wrapper">
      <input type="password" id="password" placeholder="Password">
      <button type="button" id="togglePassword" aria-label="Show/Hide password">üëÅÔ∏è</button>
    </div>
    
    <label>
      <input type="checkbox" id="remember"> Remember me
    </label><br>
    <button id="loginBtn">Unlock</button>
    <p id="error"></p>
  </div>

  <div id="content" style="display:none;">
    <h1>Welcome to the protected page!</h1>
    <p>This is the content that was locked behind the password.</p>
    
    <h2>PeerJS Chatroulette</h2>
  <div id="status">Connecting to PeerJS...</div>
  <div class="video-container">
    <div class="video-box"><video id="myVideo" autoplay muted playsinline></video></div>
    <div class="video-box"><video id="remoteVideo" autoplay playsinline></video></div>
  </div>
  <button id="nextBtn" disabled>Next Partner</button>

  <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
  <script>
  const iceServers = [
    {
      urls: [
        "stun:stun.metered.ca:80",
        "turn:turn.metered.ca:80",
        "turn:turn.metered.ca:443",
        "turns:turn.metered.ca:443"
      ],
      username: "xxxxxxxxxxxxxxxxxxxx",
      credential: "xxxxxxxxxxxxxxxxxx"
    }
  ];

  const ROOM_HOST_ID = "public-room-host";
  const statusEl = document.getElementById("status");
  const myVideo = document.getElementById("myVideo");
  const remoteVideo = document.getElementById("remoteVideo");
  const nextBtn = document.getElementById("nextBtn");

  let peer, myId, isHost = false;
  let connToHost = null, currentCall = null, connectedPartner = null;
  let myStream = null;
  const queue = []; // host only

  // --- Initialize Peer
  peer = new Peer({ host: "0.peerjs.com", port: 443, secure: true, config: { iceServers } });

  peer.on("open", async id => {
    myId = id;
    statusEl.textContent = "Connected to PeerJS. ID: " + id;
    await determineRole();
  });

  // --- Determine Host or Client
  async function determineRole() {
    const testConn = peer.connect(ROOM_HOST_ID);
    let decided = false;

    const timer = setTimeout(() => {
      if (!decided) {
        testConn.close();
        decided = true;
        becomeHost();
      }
    }, 2500);

    testConn.on("open", () => {
      if (decided) return;
      clearTimeout(timer);
      decided = true;
      testConn.close(); // close probe connection
      joinHost(); // connect properly
    });

    testConn.on("error", () => {
      if (decided) return;
      clearTimeout(timer);
      decided = true;
      becomeHost();
    });
  }

  // --- Become Host
  function becomeHost() {
    if (isHost) return;
    isHost = true;
    peer.destroy();
    peer = new Peer(ROOM_HOST_ID, { host: "0.peerjs.com", port: 443, secure: true, config: { iceServers } });
    peer.on("open", () => {
      statusEl.textContent = "You are the host. Waiting for visitors...";
      setupHost();
    });
  }

  // --- Host setup
  function setupHost() {
    peer.on("connection", conn => {
      conn.on("data", msg => {
        if (msg.type === "joinQueue") {
          queue.push(conn);
          maybePair();
        }
      });
    });
  }

  function maybePair() {
    while (queue.length >= 2) {
      const a = queue.shift();
      const b = queue.shift();
      a.send({ type: "partner", id: b.peer });
      b.send({ type: "partner", id: a.peer });
    }
  }

  // --- Join Host as Client
  function joinHost() {
    connToHost = peer.connect(ROOM_HOST_ID);
    connToHost.on("open", () => {
      nextBtn.disabled = false;
      statusEl.textContent = "Connected to host. Click 'Next Partner' to start!";
    });
    connToHost.on("data", msg => {
      if (msg.type === "partner") connectToPartner(msg.id);
    });
  }

  // --- Start Media Stream
  async function startMyStream() {
    if (myStream) return;
    try {
      myStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
      myVideo.srcObject = myStream;
    } catch (err) {
      alert("Camera/mic access denied: " + err.message);
    }
  }

  // --- Connect to Partner
  function connectToPartner(partnerId) {
    startMyStream();
    statusEl.textContent = "Connecting to partner...";
    const call = peer.call(partnerId, myStream);
    currentCall = call;
    connectedPartner = partnerId;
    call.on("stream", stream => {
      remoteVideo.srcObject = stream;
      statusEl.textContent = "Connected! Click 'Next Partner' anytime.";
      nextBtn.disabled = false;
    });
    call.on("close", handleDisconnect);
    call.on("error", handleDisconnect);
  }

  // --- Incoming Calls
  peer.on("call", call => {
    startMyStream();
    call.answer(myStream);
    currentCall = call;
    connectedPartner = call.peer;
    call.on("stream", stream => {
      remoteVideo.srcObject = stream;
      statusEl.textContent = "Connected! Click 'Next Partner' anytime.";
      nextBtn.disabled = false;
    });
    call.on("close", handleDisconnect);
  });

  // --- Data: Disconnect notice
  peer.on("connection", conn => {
    conn.on("data", data => {
      if (data.type === "disconnect") handleDisconnect();
    });
  });

  function handleDisconnect() {
    if (currentCall) currentCall.close();
    connectedPartner = null;
    remoteVideo.srcObject = null;
    statusEl.textContent = "Partner disconnected. Click 'Next Partner'.";
  }

  // --- Next Partner Button
  nextBtn.onclick = async () => {
    if (connectedPartner) {
      try {
        const dc = peer.connect(connectedPartner);
        dc.on("open", () => { dc.send({ type: "disconnect" }); dc.close(); });
      } catch {}
      if (currentCall) currentCall.close();
      connectedPartner = null;
      remoteVideo.srcObject = null;
    }

    await startMyStream();

    if (!connToHost || !connToHost.open) {
      joinHost(); // ensure host connection
    } else {
      connToHost.send({ type: "joinQueue" });
      statusEl.textContent = "Waiting for next partner...";
    }
  };
  </script>
    
    
    <button id="logout">Logout</button>
  </div>

  <script src="script.js"></script>
</body>
</html>
