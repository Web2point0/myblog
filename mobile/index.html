<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>PeerJS Video Chat (Mobile Friendly)</title>
  <style>
    body {
      font-family: sans-serif;
      text-align: center;
      background: #0d1117;
      color: #fff;
      margin: 0;
      padding: 0;
    }
    h2 {
      margin-top: 15px;
      font-size: 1.3em;
    }
    #controls {
      margin: 10px;
    }
    input, button {
      padding: 10px;
      margin: 5px;
      border-radius: 8px;
      border: none;
      font-size: 1em;
    }
    button {
      background: #1f6feb;
      color: #fff;
      cursor: pointer;
    }
    button:hover {
      background: #388bfd;
    }
    #video-container {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      align-items: center;
      gap: 10px;
      margin: 10px;
    }
    video {
      width: 45%;
      max-width: 400px;
      border-radius: 12px;
      background: #000;
    }

    /* Mobile responsive layout */
    @media (max-width: 768px) {
      video {
        width: 90%;
      }
    }

    #pipBtn {
      background: #238636;
      margin-top: 10px;
    }

  </style>
</head>
<body>
  <h2>One-on-One Video Chat</h2>
  <div id="peer-id">Connecting to PeerJS...</div>
  <div id="controls">
    <input id="remoteId" placeholder="Enter partner ID" />
    <button id="connectBtn">Connect</button>
  </div>

  <div id="video-container">
    <video id="myVideo" autoplay muted playsinline></video>
    <video id="remoteVideo" autoplay playsinline></video>
  </div>

  <button id="pipBtn">Picture-in-Picture</button>

  <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
  <script>
    const iceServers = [
      {
        urls: [
          "stun:stun.metered.ca:80",
          "turn:turn.metered.ca:80",
          "turn:turn.metered.ca:443?transport=tcp",
          "turns:turn.metered.ca:443?transport=tcp"
        ],
        username: "a1b6372ba64416abdabd7b44",
        credential: "do1BGC+KPZA6pmdF"
      }
    ];

    const peer = new Peer({
      host: "0.peerjs.com",
      port: 443,
      secure: true,
      config: { iceServers }
    });

    const myVideo = document.getElementById("myVideo");
    const remoteVideo = document.getElementById("remoteVideo");
    const peerIdDisplay = document.getElementById("peer-id");
    const connectBtn = document.getElementById("connectBtn");
    const remoteIdInput = document.getElementById("remoteId");
    const pipBtn = document.getElementById("pipBtn");

    let myStream;

    peer.on("open", id => {
      peerIdDisplay.innerText = "Your Peer ID: " + id;
      console.log("My Peer ID:", id);
    });

    navigator.mediaDevices.getUserMedia({ video: true, audio: true })
      .then(stream => {
        myStream = stream;
        myVideo.srcObject = stream;
      })
      .catch(err => console.error("Failed to get media:", err));

    connectBtn.onclick = () => {
      const remoteId = remoteIdInput.value.trim();
      if (!remoteId) return alert("Enter a partner ID");
      const call = peer.call(remoteId, myStream);
      call.on("stream", remoteStream => remoteVideo.srcObject = remoteStream);
    };

    peer.on("call", call => {
      call.answer(myStream);
      call.on("stream", remoteStream => remoteVideo.srcObject = remoteStream);
    });

    // Picture-in-Picture feature
    pipBtn.addEventListener("click", async () => {
      try {
        if (document.pictureInPictureElement) {
          await document.exitPictureInPicture();
        } else {
          // Prefer remote video in PiP, fallback to self if not available yet
          const targetVideo = remoteVideo.srcObject ? remoteVideo : myVideo;
          await targetVideo.requestPictureInPicture();
        }
      } catch (err) {
        alert("Picture-in-Picture not supported or blocked by browser.");
        console.error(err);
      }
    });
  </script>
</body>
</html>
