<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>PeerJS Video Chat (Mobile + PiP + Mini View)</title>
  <style>
    body {
      font-family: sans-serif;
      text-align: center;
      background: #0d1117;
      color: #fff;
      margin: 0;
      padding: 0;
      overflow-x: hidden;
    }
    h2 { margin-top: 15px; font-size: 1.3em; }
    #controls { margin: 10px; }
    input, button {
      padding: 10px;
      margin: 5px;
      border-radius: 8px;
      border: none;
      font-size: 1em;
    }
    button {
      background: #1f6feb;
      color: #fff;
      cursor: pointer;
    }
    button:hover { background: #388bfd; }
    #video-container {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      align-items: center;
      gap: 10px;
      margin: 10px;
    }
    video {
      width: 45%;
      max-width: 400px;
      border-radius: 12px;
      background: #000;
    }
    @media (max-width: 768px) {
      video { width: 90%; }
    }
    #pipBtn {
      background: #238636;
      margin-top: 10px;
    }

    /* Mini overlay mode */
    #miniVideoContainer {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 200px;
      background: #000;
      border: 2px solid #333;
      border-radius: 10px;
      z-index: 9999;
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      box-shadow: 0 0 12px rgba(0,0,0,0.6);
    }
    #miniVideoContainer video {
      width: 100%;
      border-radius: 10px;
    }
    #miniControls {
      display: flex;
      justify-content: space-between;
      width: 100%;
      background: rgba(0,0,0,0.5);
      border-top: 1px solid #444;
    }
    #miniControls button {
      flex: 1;
      font-size: 0.8em;
      padding: 6px;
      background: transparent;
      color: #fff;
      border: none;
    }
    #miniControls button:hover {
      background: rgba(255,255,255,0.2);
    }
  </style>
</head>
<body>
  <h2>One-on-One Video Chat</h2>
  <div id="peer-id">Connecting to PeerJS...</div>
  <div id="controls">
    <input id="remoteId" placeholder="Enter partner ID" />
    <button id="connectBtn">Connect</button>
  </div>

  <div id="video-container">
    <video id="myVideo" autoplay muted playsinline></video>
    <video id="remoteVideo" autoplay playsinline></video>
  </div>

  <button id="pipBtn">Picture-in-Picture / Mini View</button>

  <!-- Mini video overlay -->
  <div id="miniVideoContainer">
    <video id="miniVideo" autoplay muted playsinline></video>
    <div id="miniControls">
      <button id="closeMini">âœ•</button>
    </div>
  </div>

  <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
  <script>
    const iceServers = [
      {
        urls: [
          "stun:stun.metered.ca:80",
          "turn:turn.metered.ca:80",
          "turn:turn.metered.ca:443?transport=tcp",
          "turns:turn.metered.ca:443?transport=tcp"
        ],
        username: "a1b6372ba64416abdabd7b44",
        credential: "do1BGC+KPZA6pmdF"
      }
    ];

    const peer = new Peer({
      host: "0.peerjs.com",
      port: 443,
      secure: true,
      config: { iceServers }
    });

    const myVideo = document.getElementById("myVideo");
    const remoteVideo = document.getElementById("remoteVideo");
    const peerIdDisplay = document.getElementById("peer-id");
    const connectBtn = document.getElementById("connectBtn");
    const remoteIdInput = document.getElementById("remoteId");
    const pipBtn = document.getElementById("pipBtn");

    const miniContainer = document.getElementById("miniVideoContainer");
    const miniVideo = document.getElementById("miniVideo");
    const closeMini = document.getElementById("closeMini");

    let myStream;

    peer.on("open", id => {
      peerIdDisplay.innerText = "Your Peer ID: " + id;
      console.log("My Peer ID:", id);
    });

    navigator.mediaDevices.getUserMedia({ video: true, audio: true })
      .then(stream => {
        myStream = stream;
        myVideo.srcObject = stream;
      })
      .catch(err => console.error("Failed to get media:", err));

    connectBtn.onclick = () => {
      const remoteId = remoteIdInput.value.trim();
      if (!remoteId) return alert("Enter a partner ID");
      const call = peer.call(remoteId, myStream);
      call.on("stream", remoteStream => remoteVideo.srcObject = remoteStream);
    };

    peer.on("call", call => {
      call.answer(myStream);
      call.on("stream", remoteStream => remoteVideo.srcObject = remoteStream);
    });

    // --- Picture-in-Picture or fallback Mini View ---
    pipBtn.addEventListener("click", async () => {
      const targetVideo = remoteVideo.srcObject ? remoteVideo : myVideo;
      try {
        if (document.pictureInPictureElement) {
          await document.exitPictureInPicture();
        } else if (document.pictureInPictureEnabled) {
          await targetVideo.requestPictureInPicture();
        } else {
          throw new Error("PiP not supported");
        }
      } catch (err) {
        console.warn("PiP failed:", err);
        // Offer mini floating view instead
        const confirmMini = confirm("Picture-in-Picture not supported.\nWould you like to open mini floating view instead?");
        if (confirmMini) {
          openMiniView(targetVideo);
        }
      }
    });

    function openMiniView(videoEl) {
      miniVideo.srcObject = videoEl.srcObject;
      miniContainer.style.display = "flex";
      enableDrag(miniContainer);
    }

    closeMini.onclick = () => {
      miniContainer.style.display = "none";
      miniVideo.srcObject = null;
    };

    // --- Make mini overlay draggable ---
    function enableDrag(element) {
      let offsetX, offsetY, dragging = false;

      element.addEventListener("touchstart", startDrag);
      element.addEventListener("mousedown", startDrag);
      window.addEventListener("touchend", stopDrag);
      window.addEventListener("mouseup", stopDrag);
      window.addEventListener("touchmove", drag);
      window.addEventListener("mousemove", drag);

      function startDrag(e) {
        dragging = true;
        const rect = element.getBoundingClientRect();
        offsetX = (e.touches ? e.touches[0].clientX : e.clientX) - rect.left;
        offsetY = (e.touches ? e.touches[0].clientY : e.clientY) - rect.top;
      }
      function stopDrag() { dragging = false; }
      function drag(e) {
        if (!dragging) return;
        e.preventDefault();
        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const clientY = e.touches ? e.touches[0].clientY : e.clientY;
        element.style.left = (clientX - offsetX) + "px";
        element.style.top = (clientY - offsetY) + "px";
        element.style.right = "auto";
        element.style.bottom = "auto";
      }
    }
  </script>
</body>
</html>
