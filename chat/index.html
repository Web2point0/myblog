<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LAN Mesh Chat</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        #joinSection { margin-bottom: 20px; }
        #chat { border: 1px solid #ccc; height: 300px; overflow-y: scroll; padding: 10px; margin-bottom: 10px; }
        #users { border: 1px solid #ccc; padding: 10px; margin-bottom: 10px; }
        input, button { margin: 5px; padding: 5px; }
        .message { margin: 5px 0; }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/webconnect@0.0.10/dist/umd/webconnect.js"></script>
</head>
<body>
    <h1>LAN Mesh Chat</h1>
    <div id="joinSection">
        <label for="username">Username:</label>
        <input type="text" id="username" placeholder="Enter your username" required>
        <button id="joinBtn">Join Network</button>
    </div>
    <div id="chatSection" style="display: none;">
        <div id="users"></div>
        <div id="chat"></div>
        <input type="text" id="message" placeholder="Type a message..." style="width: 70%;">
        <button id="sendBtn">Send</button>
    </div>

  <script>
    let connect;
    let myUsername;
    let userMap = new Map(); // connectId -> username
    const chat = document.getElementById('chat');
    const usersDiv = document.getElementById('users');
    const joinSection = document.getElementById('joinSection');
    const chatSection = document.getElementById('chatSection');

    document.getElementById('joinBtn').addEventListener('click', joinNetwork);
    document.getElementById('sendBtn').addEventListener('click', sendMessage);

    function joinNetwork() {
        myUsername = document.getElementById('username').value.trim();
        if (!myUsername) {
            alert('Please enter a username');
            return;
        }

        connect = webconnect({
            appName: "MeshChat",
            channelName: "lan-channel"
            // Add connectPassword if needed for encryption
        });

        setupEventListeners();

        // Add self to map
        userMap.set('self', myUsername);
        updateUsersList();

        // Get existing connections and send username
        setTimeout(() => {
            connect.getConnection((attribute) => {
                const connections = attribute.connections || []; // Assuming attribute.connections is array of connectIds
                connections.forEach(connectId => {
                    if (connectId !== 'self') {
                        sendUsername(connectId);
                    }
                });
            });
        }, 1000); // Small delay to allow init

        joinSection.style.display = 'none';
        chatSection.style.display = 'block';
        document.getElementById('message').focus();
    }

    function setupEventListeners() {
        connect.onConnect((attribute) => {
            console.log('Connected to:', attribute.connectId);
            sendUsername(attribute.connectId);
            updateUsersList(); // Will update when username received
        });

        connect.onDisconnect((attribute) => {
            console.log('Disconnected from:', attribute.connectId);
            userMap.delete(attribute.connectId);
            updateUsersList();
        });

        connect.onReceive((data, attribute) => {
            if (typeof data === 'string') {
                try {
                    data = JSON.parse(data);
                } catch (e) {
                    // If not JSON, treat as plain text (fallback)
                }
            }

            if (data.type === 'username') {
                userMap.set(attribute.connectId, data.username);
                updateUsersList();
            } else if (data.type === 'message') {
                addMessage(`${data.from}: ${data.text}`);
            }
        });
    }

    function sendUsername(targetId) {
        const msg = { type: 'username', username: myUsername };
        connect.Send(JSON.stringify(msg), { connectId: targetId });
    }

    function sendMessage() {
        const msgText = document.getElementById('message').value.trim();
        if (!msgText) return;

        // Add the sender's message to their own chat
        addMessage(`${myUsername}: ${msgText}`);

        // Broadcast to all peers
        const msg = { type: 'message', from: myUsername, text: msgText };
        connect.Send(JSON.stringify(msg), { connectId: null });

        document.getElementById('message').value = '';
    }

    function addMessage(text) {
        const div = document.createElement('div');
        div.className = 'message';
        div.textContent = text;
        chat.appendChild(div);
        chat.scrollTop = chat.scrollHeight;
    }

    function updateUsersList() {
        usersDiv.innerHTML = '<h3>Connected Users:</h3><ul>' +
            Array.from(userMap.values()).map(u => `<li>${u}</li>`).join('') +
            '</ul>';
    }

    // Allow Enter to send
    document.getElementById('message').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') sendMessage();
    });
</script>
</body>
</html>





