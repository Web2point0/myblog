<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Comment System with Replies (Admin-safe deletion)</title>
<style>
body { font-family: Arial; margin: 20px; background: #f8f9fa; color: #222; }
.comment, .reply { background: #fff; border: 1px solid #ccc; border-radius: 8px; padding: 10px; margin-bottom: 10px; transition: opacity 0.4s, transform 0.4s; }
.comment.adminMode, .reply.adminMode { border-color: #6ea8fe; cursor: pointer; }
.comment.fade-out, .reply.fade-out { opacity: 0; transform: translateY(-10px); }
.reply { margin-left: 20px; background: #eef6ff; }
.replyForm { margin-left: 20px; margin-top: 5px; }
input, textarea { padding: 6px; margin: 4px 0; width: 100%; }
button { padding: 6px 12px; margin-top: 4px; cursor: pointer; }
</style>
</head>
<body>

<h2>ðŸ’¬ Comments</h2>
<form id="commentForm">
  <input id="nameInput" placeholder="Your name" required />
  <textarea id="commentInput" rows="3" placeholder="Write a comment..." required></textarea>
  <button type="submit">Post Comment</button>
</form>

<div id="commentList"></div>

<div id="adminPanel">
  <h3>Admin Panel</h3>
  <input type="password" id="adminPassword" placeholder="Enter admin password">
  <button id="adminLogin">Login</button>
  <button id="adminLogout" style="display:none;">Logout</button>
</div>

<script>
const API = "https://comments.myyear.net"; // replace with your worker URL
let isAdmin = false;
let clickCounts = {};

// Fetch comments
async function fetchComments() {
  const res = await fetch(`${API}/comments`, { credentials: "include" });
  const comments = await res.json();
  renderComments(comments);
}

// Render comments + replies
function renderComments(comments) {
  const list = document.getElementById("commentList");
  list.innerHTML = "";

  const parentIds = new Set(comments.filter(c => !c.parentId).map(c=>c.id));
  const topComments = comments.filter(c => !c.parentId || !parentIds.has(c.parentId));

  topComments.sort((a,b)=>b.time - a.time).forEach(c => {
    const div = createCommentDiv(c, comments);
    list.appendChild(div);
  });
}

function createCommentDiv(comment, allComments) {
  const div = document.createElement("div");
  const isOrphan = comment.parentId && !allComments.some(p => p.id === comment.parentId);
  div.className = isOrphan ? "reply" : "comment";
  div.dataset.id = comment.id;

  div.innerHTML = `
    ${isOrphan ? `<em>Parent deleted</em><br>` : ""}
    <div><strong>${comment.name}</strong></div>
    <div>${comment.text}</div>
    <div style="font-size:0.8em;color:#555;">${new Date(comment.time).toLocaleString()}</div>
    ${!isOrphan ? '<button class="replyBtn">Reply</button><div class="repliesContainer"></div>' : ''}
  `;

  // Admin-only delete
  if(isAdmin){
    div.classList.add("adminMode");
    setupDeleteGesture(div);
  }

  // Render replies
  if(!isOrphan){
    const repliesContainer = div.querySelector(".repliesContainer");
    const replies = allComments.filter(r=>r.parentId===comment.id).sort((a,b)=>a.time-b.time);
    replies.forEach(r=>{
      const replyDiv = document.createElement("div");
      replyDiv.className="reply";
      replyDiv.dataset.id=r.id;
      replyDiv.innerHTML = `
        <div><strong>${r.name}</strong></div>
        <div>${r.text}</div>
        <div style="font-size:0.8em;color:#555;">${new Date(r.time).toLocaleString()}</div>
      `;
      if(isAdmin) setupDeleteGesture(replyDiv); // attach delete only to reply
      repliesContainer.appendChild(replyDiv);
    });

    // Reply button
    const replyBtn = div.querySelector(".replyBtn");
    replyBtn.addEventListener("click", ()=>{
      if(div.querySelector(".replyForm")) return;
      const formDiv = document.createElement("div");
      formDiv.className="replyForm";
      formDiv.innerHTML = `
        <input placeholder="Your name" required class="replyName"/>
        <textarea placeholder="Write a reply..." rows="2" required class="replyText"></textarea>
        <button>Post Reply</button>
      `;
      const btn = formDiv.querySelector("button");
      btn.addEventListener("click", async ()=>{
        const name = formDiv.querySelector(".replyName").value.trim();
        const text = formDiv.querySelector(".replyText").value.trim();
        if(!name||!text) return;
        await postComment(name,text,comment.id);
        fetchComments();
      });
      div.appendChild(formDiv);
    });
  }

  return div;
}

// Post comment/reply
async function postComment(name,text,parentId=null){
  await fetch(`${API}/comments`,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body: JSON.stringify({name,text,parentId})
  });
}

// Admin 10-click delete
function setupDeleteGesture(div){
  if(!isAdmin) return;
  clickCounts[div.dataset.id] = 0;
  div.addEventListener("click", async e=>{
    e.stopPropagation();
    clickCounts[div.dataset.id]++;
    if(clickCounts[div.dataset.id]>=10){
      await fetch(`${API}/comments/delete`,{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        credentials:"include",
        body: JSON.stringify({id: div.dataset.id})
      });
      div.classList.add("fade-out");
      setTimeout(()=>{ div.remove(); },400); // remove only this div
      clickCounts[div.dataset.id]=0;
    }
  });
}

// Top-level comment submit
document.getElementById("commentForm").addEventListener("submit", async e=>{
  e.preventDefault();
  const name = document.getElementById("nameInput").value.trim();
  const text = document.getElementById("commentInput").value.trim();
  if(!name||!text) return;
  await postComment(name,text);
  document.getElementById("commentInput").value="";
  fetchComments();
});

// Admin login/logout
document.getElementById("adminLogin").addEventListener("click", async ()=>{
  const password = document.getElementById("adminPassword").value.trim();
  const res = await fetch(`${API}/login`,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    credentials:"include",
    body: JSON.stringify({password})
  });
  if(res.ok){
    isAdmin=true;
    document.getElementById("adminPassword").value="";
    document.getElementById("adminLogin").style.display="none";
    document.getElementById("adminLogout").style.display="inline-block";
    fetchComments();
  } else alert("Wrong password");
});

document.getElementById("adminLogout").addEventListener("click", async ()=>{
  await fetch(`${API}/logout`,{method:"POST", credentials:"include"});
  isAdmin=false;
  document.getElementById("adminLogin").style.display="inline-block";
  document.getElementById("adminLogout").style.display="none";
  fetchComments();
});

fetchComments();
</script>
</body>
</html>
