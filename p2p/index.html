<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebRTC Mesh Chat</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: auto;
        }
        #username-div, #chat-div, #connect-div {
            background: white;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        #messages {
            border: 1px solid #ccc;
            height: 200px;
            overflow-y: auto;
            padding: 10px;
            margin-bottom: 10px;
            background: #fafafa;
        }
        #users {
            font-weight: bold;
            margin-bottom: 10px;
        }
        input[type="text"], textarea {
            width: 100%;
            padding: 8px;
            margin: 5px 0;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
        }
        textarea {
            height: 80px;
            resize: vertical;
        }
        button {
            padding: 8px 15px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px 5px 5px 0;
        }
        button:hover {
            background-color: #0056b3;
        }
        h3 {
            margin-top: 10px;
            color: #333;
        }
        .instruction {
            font-size: 0.9em;
            color: #555;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="username-div">
            <label for="username-input">Enter your username:</label>
            <input id="username-input" type="text" placeholder="Your username" required>
            <button id="set-username">Set Username</button>
        </div>

        <div id="chat-div" style="display: none;">
            <div>Connected users: <span id="users">None</span></div>
            <div id="messages"></div>
            <input id="message-input" type="text" placeholder="Type your message">
            <button id="send">Send</button>
        </div>

        <div id="connect-div" style="display: none;">
            <h3>Initiate a Connection (Create Offer)</h3>
            <p class="instruction">Click "Create Offer" to generate an SDP offer. Copy the SDP text and share it with another user on the local network (e.g., via USB, email, or manual transfer).</p>
            <button id="create-offer">Create Offer</button>
            <textarea id="offer-sdp" placeholder="Your offer SDP will appear here. Copy and share it." readonly></textarea>

            <h3>Join a Connection (Create Answer)</h3>
            <p class="instruction">Paste the offer SDP from another user below, then click "Create Answer". Copy the generated answer SDP and send it back to the offer creator.</p>
            <textarea id="remote-offer" placeholder="Paste the offer SDP from another user here"></textarea>
            <button id="create-answer">Create Answer</button>
            <textarea id="answer-output" placeholder="Your answer SDP will appear here. Copy and send it back." readonly></textarea>

            <h3>Finalize Connection (Set Answer)</h3>
            <p class="instruction">If you created the offer, paste the answer SDP from the other user here to complete the connection.</p>
            <textarea id="answer-sdp" placeholder="Paste the answer SDP from the other user here"></textarea>
            <button id="set-answer">Set Answer</button>
        </div>
    </div>

    <script>
        let username = localStorage.getItem('username');
        const usernameDiv = document.getElementById('username-div');
        const chatDiv = document.getElementById('chat-div');
        const connectDiv = document.getElementById('connect-div');
        const usersSpan = document.getElementById('users');
        const messagesDiv = document.getElementById('messages');
        const messageInput = document.getElementById('message-input');
        const sendButton = document.getElementById('send');
        const createOfferButton = document.getElementById('create-offer');
        const offerSdp = document.getElementById('offer-sdp');
        const remoteOffer = document.getElementById('remote-offer');
        const createAnswerButton = document.getElementById('create-answer');
        const answerOutput = document.getElementById('answer-output');
        const answerSdp = document.getElementById('answer-sdp');
        const setAnswerButton = document.getElementById('set-answer');

        let peers = [];
        let seenMessages = new Set();
        let currentInitiatorPc = null;
        let knownUsernames = new Set();

        // Initialize UI based on username
        if (username) {
            initializeChat();
        }

        document.getElementById('set-username').addEventListener('click', () => {
            username = document.getElementById('username-input').value.trim();
            if (username) {
                localStorage.setItem('username', username);
                knownUsernames.add(username);
                updateUsers();
                initializeChat();
            } else {
                alert('Please enter a valid username');
            }
        });

        function initializeChat() {
            usernameDiv.style.display = 'none';
            chatDiv.style.display = 'block';
            connectDiv.style.display = 'block';
            setupEventListeners();
        }

        function setupEventListeners() {
            sendButton.addEventListener('click', sendMessage);
            createOfferButton.addEventListener('click', createOffer);
            createAnswerButton.addEventListener('click', createAnswer);
            setAnswerButton.addEventListener('click', setAnswer);
        }

        function createPeer(isInitiator = false) {
            const config = { iceServers: [] }; // Local network, no STUN/TURN
            const pc = new RTCPeerConnection(config);
            let channel;

            if (isInitiator) {
                channel = pc.createDataChannel('chat');
                setupChannel(channel, pc);
                pc.channel = channel;
            } else {
                pc.ondatachannel = (e) => {
                    channel = e.channel;
                    setupChannel(channel, pc);
                    pc.channel = channel;
                };
            }

            pc.onicecandidate = (e) => {
                if (!e.candidate && pc.localDescription) {
                    if (isInitiator) {
                        offerSdp.value = JSON.stringify(pc.localDescription);
                    } else {
                        answerOutput.value = JSON.stringify(pc.localDescription);
                    }
                }
            };

            pc.onconnectionstatechange = () => {
                if (pc.connectionState === 'failed' || pc.connectionState === 'disconnected') {
                    peers = peers.filter(p => p !== pc);
                    updateUsers();
                }
            };

            peers.push(pc);
            return pc;
        }

        function setupChannel(channel, pc) {
            channel.onopen = () => {
                channel.send(JSON.stringify({ type: 'username', name: username }));
            };

            channel.onmessage = (e) => {
                const data = JSON.parse(e.data);
                if (data.type === 'username') {
                    pc.peerUsername = data.name;
                    knownUsernames.add(data.name);
                    updateUsers();
                } else if (data.type === 'message') {
                    const { id, from, text } = data;
                    if (!seenMessages.has(id)) {
                        seenMessages.add(id);
                        appendMessage(`${from}: ${text}`);
                        // Relay to other peers
                        peers.forEach(otherPc => {
                            if (otherPc !== pc && otherPc.channel?.readyState === 'open') {
                                otherPc.channel.send(e.data);
                            }
                        });
                    }
                }
            };
        }

        async function createOffer() {
            const pc = createPeer(true);
            currentInitiatorPc = pc;
            const offer = await pc.createOffer();
            await pc.setLocalDescription(offer);
            offerSdp.value = 'Generating offer...';
        }

        async function createAnswer() {
            const offerText = remoteOffer.value.trim();
            if (!offerText) {
                alert('Please paste a valid offer SDP');
                return;
            }
            let offerSdpObj;
            try {
                offerSdpObj = JSON.parse(offerText);
            } catch (e) {
                alert('Invalid offer SDP format');
                return;
            }
            const pc = createPeer(false);
            await pc.setRemoteDescription(new RTCSessionDescription(offerSdpObj));
            const answer = await pc.createAnswer();
            await pc.setLocalDescription(answer);
            answerOutput.value = 'Generating answer...';
        }

        async function setAnswer() {
            if (!currentInitiatorPc) {
                alert('No active offer to set an answer for');
                return;
            }
            const sdpText = answerSdp.value.trim();
            if (!sdpText) {
                alert('Please paste a valid answer SDP');
                return;
            }
            let sdp;
            try {
                sdp = JSON.parse(sdpText);
            } catch (e) {
                alert('Invalid answer SDP format');
                return;
            }
            await currentInitiatorPc.setRemoteDescription(new RTCSessionDescription(sdp));
            answerSdp.value = '';
        }

        function sendMessage() {
            const text = messageInput.value.trim();
            if (!text) return;
            messageInput.value = '';
            const id = crypto.randomUUID();
            const msg = { type: 'message', id, from: username, text };
            const json = JSON.stringify(msg);
            seenMessages.add(id);
            appendMessage(`${username} (me): ${text}`);
            peers.forEach(pc => {
                if (pc.channel && pc.channel.readyState === 'open') {
                    pc.channel.send(json);
                }
            });
        }

        function appendMessage(msg) {
            const div = document.createElement('div');
            div.textContent = msg;
            div.style.padding = '5px';
            messagesDiv.appendChild(div);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function updateUsers() {
            const connected = peers
                .filter(pc => pc.peerUsername)
                .map(pc => pc.peerUsername)
                .join(', ') || 'None';
            usersSpan.textContent = connected;
        }
    </script>
</body>
</html>